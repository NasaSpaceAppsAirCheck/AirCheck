<html>
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.css">
  </head>
  <style type="text/css">
    body {
        background-color: eeeeee !important;
    }
    .pie-chart {
      width: 300px; 
      height: 300px;
    }
  </style>
  <body>
    <div class="container">
      <br />
      <div class="row">
        <div class="col-xs-4"></div>
        <div class="col-xs-4">
          <select class="form-control" id="aqi-selection">
            <option>Select Air Quality Index</option>
            <option>Good (AQI 1-50)</option>
            <option>Moderate (AQI 51-100)</option>
            <option>Unhealthy for Sensitive Groups (AQI 101-150)</option>
            <option>Unhealthy (AQI 151-200)</option>
            <option>Very Unhealthy (AQI 201-250)</option>
            <option>Hazardous (AQI 251-300)</option>
          </select>
        </div>
        <div class="col-xs-4"></div>
      </div>
      <hr />
      <div class="row">
        <div class="col-xs-4">
          <div id="cough_div" class="pie-chart"></div>
        </div>
        <div class="col-xs-4">
          <div id="wheeze_div" class="pie-chart"></div>
        </div>
        <div class="col-xs-4">
          <div id="shortBreath_div" class="pie-chart"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-4">
          <div id="sneeze_div" class="pie-chart"></div>
        </div>
        <div class="col-xs-4">
          <div id="noseBlock_div" class="pie-chart"></div>
        </div>
        <div class="col-xs-4">
          <div id="itchyEyes_div" class="pie-chart"></div>
        </div>
      </div>
    </div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/js/umd/dropdown.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    var selectedAqiValue = "Select Air Quality Index";
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(function(){});
    $("#aqi-selection").change(function () {
        selectedAqiValue = this.value;
        getSymptomData();
    });

    function drawChartBySymptom(symptomData, symptom) {
      symptomDiv = symptom + "_div"
      var options = {'title':getChartNameForSymptom(symptom),
                     'titleTextStyle': {fontSize: 22},
                     'width':400,
                     'height':300,
                     'backgroundColor': '#eeeeee'};
      var chart = new google.visualization.PieChart(document.getElementById(symptomDiv));
      chart.draw(symptomData, options);
    }

    function getChartNameForSymptom(symptom) {
      switch(symptom) {
        case "cough":
          return "Coughing";
        case "wheeze":
          return "Wheezing";
        case "shortBreath":
          return "Shortness of Breath";
        case "sneeze":
          return "Sneezing";
        case "noseBlock":
          return "Stuffy Nose";
        case "itchyEyes":
          return "Itchy Eyes";
        default:
          return "How Severe are symptoms.";
      }
    }

    function getAqiQuery() {
      switch(selectedAqiValue) {
        case "Good (AQI 1-50)":
          return "q=AQI:[0+TO+50]&";
        case "Moderate (AQI 51-100)":
          return "q=AQI:[51+TO+100]&";
        case "Unhealthy for Sensitive Groups (AQI 101-150)":
          return "q=AQI:[101+TO+150]&";
        case "Unhealthy (AQI 151-200)":
          return "q=AQI:[151+TO+200]&";
        case "Very Unhealthy (AQI 201-300)":
          return "q=AQI:[201+TO+300]&";
        case "Hazardous (AQI 301-500)":
          return "q=AQI:[301+TO+500]&";
        default:
          return "";
      }
    }

    function createVisualizationDataBasedOnSymptom(jsonData, symptom) {
      jsonData = _.map(jsonData.hits.hits, function(s) {return s['_source'] });
      jsonData = _.where(jsonData, { 'symptom': symptom });
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Severity');
      data.addColumn('number', 'Count');
      var rowData = [['good', _.size(_.filter(jsonData, function(s) {return s['severity'] == 0 }))],
        ['ok', _.size(_.filter(jsonData, function(s) {return s['severity'] == 1 }))],
        ['meh', _.size(_.filter(jsonData, function(s) {return s['severity'] == 2 }))],
        ['bad', _.size(_.filter(jsonData, function(s) {return s['severity'] == 3 }))],
        ['horrible', _.size(_.filter(jsonData, function(s) {return s['severity'] == 4 }))]];
      data.addRows(rowData);
      return data;
    }

    function getSymptomData() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (xhttp.readyState == 4 && xhttp.status == 200) {
          drawChartBySymptom(createVisualizationDataBasedOnSymptom(JSON.parse(xhttp.responseText), 'cough'), 'cough');
          drawChartBySymptom(createVisualizationDataBasedOnSymptom(JSON.parse(xhttp.responseText), 'wheeze'), 'wheeze');
          drawChartBySymptom(createVisualizationDataBasedOnSymptom(JSON.parse(xhttp.responseText), 'shortBreath'), 'shortBreath');
          drawChartBySymptom(createVisualizationDataBasedOnSymptom(JSON.parse(xhttp.responseText), 'sneeze'), 'sneeze');
          drawChartBySymptom(createVisualizationDataBasedOnSymptom(JSON.parse(xhttp.responseText), 'noseBlock'), 'noseBlock');
          drawChartBySymptom(createVisualizationDataBasedOnSymptom(JSON.parse(xhttp.responseText), 'itchyEyes'), 'itchyEyes');
        }
      };
      xhttp.open("GET", uriWithQuery(), true);
      xhttp.send();
    }

    function uriWithQuery() {
      var query = getAqiQuery();
      return "http://aircheck.westus.cloudapp.azure.com:9200/user/symptoms/_search?" + query + "size=10000&filter_path=**._source,aggregations.*";
    }
  </script>
</html>

<!-- cough
wheeze
shortBreath
sneeze
noseBlock
itchyEyes -->

